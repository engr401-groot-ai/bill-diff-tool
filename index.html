<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Measure Comparison - University of Hawaii</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/style.css">
</head>
<body>

    <header>
        <div class="container header-container">
            <img src="https://govrel.hawaii.edu/mt/templates/system_2019/images/uh-nameplate.png" alt="University of Hawaii" class="uh-logo">
            <div class="search-box">
                <input type="text" placeholder="Search">
                <button><i class="fas fa-search"></i></button>
            </div>
        </div>
    </header>

    <main class="container">
        <h2><strong>Measure Comparison</strong></h2>

        <div id="ai-summary-container" class="ai-summary-box">
            <div class="ai-summary-header">
                <h2>AI Summary</h2>
                <div class="summary-controls">
                    <div class="speaker-control">
                        <button id="btn-speaker-dropdown" class="btn-regenerate" title="Speaker Options">
                            <i class="fas fa-volume-up"></i>
                        </button>
                        <div id="speaker-menu" class="speaker-menu hidden">
                            <button id="btn-mute-toggle" class="menu-item">
                                <i class="fas fa-volume-up"></i> <span>Mute</span>
                            </button>
                            <button id="btn-pause-toggle" class="menu-item">
                                <i class="fas fa-pause"></i> <span>Pause</span>
                            </button>
                            <button id="btn-repeat" class="menu-item">
                                <i class="fas fa-redo"></i> Repeat
                            </button>
                        </div>
                    </div>
                    <button id="btn-regenerate" class="btn-regenerate" title="Regenerate summary">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
            <div id="ai-summary-content"></div>
            <div id="ai-loading" class="hidden">
                <div class="gemini-loader"></div>
                <p>Generating summary...</p>
            </div>
        </div>

        <div class="url-section">
            <p><strong>Original Measure URL:</strong> <span id="url-original" class="url-display">https://www.capitol.hawaii.gov/</span></p>
            <p><strong>New Measure URL:</strong> <span id="url-new" class="url-display">https://www.capitol.hawaii.gov/</span></p>
        </div>

        <div class="controls">
            <div class="input-group">
                <select id="billSelect"></select>
            </div>
        </div>

        <div class="comparison-container">
            <div class="bill-column">
                <div id="content-original" class="bill-content"></div>
            </div>
            <div class="bill-column">
                <div id="content-new" class="bill-content"></div>
            </div>
        </div>
    </main>

    <script>
        // Store all bills loaded from JSON
        let mockBills = [];
        
        // Fetch test bills from JSON file and populate dropdown
        async function loadBills() {
            try {
                const response = await fetch('/bills.json');
                if (!response.ok) {
                    throw new Error('Failed to load bills');
                }
                const bills = await response.json();
                
                mockBills = bills.map(bill => ({
                    name: bill.name,
                    original: bill.oldVersion,
                    revised: bill.newVersion,
                    originalUrl: bill.originalUrl,
                    newUrl: bill.newUrl
                }));
                
                populateDropdown();
            } catch (error) {
                console.error('Error loading bills:', error);
                mockBills = [];
            }
        }
        
        // Populate bill selection dropdown and auto-select first bill
        function populateDropdown() {
            const billSelect = document.getElementById('billSelect');
            billSelect.innerHTML = '';
            
            mockBills.forEach((bill, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = bill.name;
                billSelect.appendChild(option);
            });
            
            if (mockBills.length > 0) {
                billSelect.value = '0';
                billSelect.dispatchEvent(new Event('change'));
            }
        }
        
        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            const billSelect = document.getElementById('billSelect');
            const btnRegenerate = document.getElementById('btn-regenerate');
            const urlOriginalSpan = document.getElementById('url-original');
            const urlNewSpan = document.getElementById('url-new');
            const contentOriginalDiv = document.getElementById('content-original');
            const contentNewDiv = document.getElementById('content-new');
            const aiSummaryContent = document.getElementById('ai-summary-content');
            const aiLoading = document.getElementById('ai-loading');
            
            const btnSpeakerDropdown = document.getElementById('btn-speaker-dropdown');
            const speakerMenu = document.getElementById('speaker-menu');
            const btnMuteToggle = document.getElementById('btn-mute-toggle');
            const btnPauseToggle = document.getElementById('btn-pause-toggle');
            const btnRepeat = document.getElementById('btn-repeat');
            
            // Audio state management
            let currentAudio = null;
            let isMuted = false;
            let isPaused = false; // Track if user manually paused
            let isGenerating = false;

            // Generate localStorage key for bill summary cache
            function getCacheKey(billIndex) {
                return `bill_summary_${billIndex}`;
            }

            // Retrieve cached summary and audio from localStorage
            function getCachedSummary(billIndex) {
                const cached = localStorage.getItem(getCacheKey(billIndex));
                return cached ? JSON.parse(cached) : null;
            }

            // Save summary and audio to localStorage
            function cacheSummary(billIndex, summary, audioBase64) {
                localStorage.setItem(getCacheKey(billIndex), JSON.stringify({
                    summary: summary,
                    audio: audioBase64,
                    timestamp: Date.now()
                }));
            }

            // Play audio from base64 data
            function playAudio(base64Audio, autoPlay = true) {
                // Resume if same audio and paused, otherwise stop current audio
                if (currentAudio) {
                    if (currentAudio.src === `data:audio/mp3;base64,${base64Audio}` && isPaused) {
                        currentAudio.play();
                        isPaused = false;
                        updateSpeakerIcon(true);
                        return;
                    }
                    currentAudio.pause();
                    currentAudio = null;
                }
                
                if (!base64Audio) return;

                const audio = new Audio(`data:audio/mp3;base64,${base64Audio}`);
                currentAudio = audio;
                isPaused = false;
                
                audio.onended = () => {
                    updateSpeakerIcon(false);
                    isPaused = false;
                };

                if (autoPlay) {
                    audio.play()
                        .then(() => {
                            updateSpeakerIcon(true);
                        })
                        .catch(e => {
                            console.error("Audio play failed:", e);
                        });
                }
            }

            // Stop audio and reset all audio states
            function stopAudio() {
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio.currentTime = 0;
                }
                isPaused = false;
                isMuted = false;
                updateSpeakerIcon(false);
            }

            // Pause audio and set manual pause flag
            function pauseAudio() {
                if (currentAudio && !currentAudio.paused) {
                    currentAudio.pause();
                    isPaused = true;
                    updateSpeakerIcon(false);
                }
            }

            // Update speaker UI based on audio state
            function updateSpeakerIcon(isPlaying) {
                // Update mute button icon and text
                const muteIcon = btnMuteToggle.querySelector('i');
                const muteText = btnMuteToggle.querySelector('span');
                if (isMuted) {
                    muteIcon.className = 'fas fa-volume-mute';
                    muteText.textContent = 'Unmute';
                } else {
                    muteIcon.className = 'fas fa-volume-up';
                    muteText.textContent = 'Mute';
                }

                // Update pause button icon and text
                const pauseIcon = btnPauseToggle.querySelector('i');
                const pauseText = btnPauseToggle.querySelector('span');
                if (isPaused) {
                    pauseIcon.className = 'fas fa-play';
                    pauseText.textContent = 'Resume';
                } else {
                    pauseIcon.className = 'fas fa-pause';
                    pauseText.textContent = 'Pause';
                }
                
                // Update speaker dropdown icon
                if (isPlaying) {
                    btnSpeakerDropdown.classList.add('playing');
                } else {
                    btnSpeakerDropdown.classList.remove('playing');
                }
            }

            // Load bill comparison, either from cache or by generating new summary
            async function loadBillComparison(forceRegenerate = false, isUserInteraction = false) {
                const selectedIndex = billSelect.value;
                const bill = mockBills[selectedIndex];
                
                // Disable dropdown during generation
                billSelect.disabled = true;
                
                // Update URLs and bill content immediately
                urlOriginalSpan.textContent = bill.originalUrl;
                urlNewSpan.textContent = bill.newUrl;
                contentOriginalDiv.innerText = bill.original;
                contentNewDiv.innerText = bill.revised;

                // Try to load from cache first
                if (!forceRegenerate) {
                    const cached = getCachedSummary(selectedIndex);
                    if (cached) {
                        const formattedSummary = cached.summary
                            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                            .replace(/\n/g, '<br>');
                        aiSummaryContent.innerHTML = formattedSummary;

                        // Play cached audio if user clicked dropdown
                        if (cached.audio && isUserInteraction) {
                            isMuted = false;
                            isPaused = false;
                            playAudio(cached.audio);
                        }
                        billSelect.disabled = false;
                        return;
                    }
                }

                // Generate new summary
                stopAudio();
                aiSummaryContent.innerHTML = '';
                aiLoading.classList.remove('hidden');
                isGenerating = true;
                btnRegenerate.disabled = true;
                btnSpeakerDropdown.disabled = true;

                // Call backend API to generate summary and audio
                try {
                    const response = await fetch('/compare-and-speak', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            bill1_text: bill.original,
                            bill2_text: bill.revised
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Failed to compare bills');
                    }

                    const data = await response.json();
                    
                    if (!data.success) {
                        throw new Error(data.error || 'Unknown error occurred');
                    }

                    const summaryText = data.summary;
                    const audioData = data.audio_base64;
                    
                    const formattedSummary = summaryText
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\n/g, '<br>');
                    aiSummaryContent.innerHTML = formattedSummary;

                    cacheSummary(selectedIndex, summaryText, audioData);
                    
                    if (audioData) {
                        playAudio(audioData);
                    }

                } catch (error) {
                    console.error("Generation error:", error);
                    if (error.message !== 'Failed to fetch') {
                         alert(error.message);
                         aiSummaryContent.innerHTML = 'Error generating summary.';
                    }
                } finally {
                    aiLoading.classList.add('hidden');
                    isGenerating = false;
                    billSelect.disabled = false;
                    btnRegenerate.disabled = false;
                    btnSpeakerDropdown.disabled = false;
                }
            }

            // Speaker dropdown: toggle menu and play if not playing/paused
            btnSpeakerDropdown.addEventListener('click', (e) => {
                e.stopPropagation();
                speakerMenu.classList.toggle('hidden');
                
                if (currentAudio && !currentAudio.paused) {
                    return;
                }

                if (isPaused) {
                    return;
                }

                const selectedIndex = billSelect.value;
                const cached = getCachedSummary(selectedIndex);
                if (cached && cached.audio) {
                    playAudio(cached.audio);
                }
            });

            // Toggle mute/unmute
            btnMuteToggle.addEventListener('click', () => {
                isMuted = !isMuted;
                if (currentAudio) {
                    currentAudio.muted = isMuted;
                    if (!isMuted && currentAudio.paused && !isPaused) {
                        currentAudio.play();
                    }
                }
                updateSpeakerIcon(currentAudio && !currentAudio.paused);
            });

            // Toggle pause/resume
            btnPauseToggle.addEventListener('click', () => {
                if (isPaused) {
                    if (currentAudio) {
                        currentAudio.play();
                        isPaused = false;
                    } else {
                        const selectedIndex = billSelect.value;
                        const cached = getCachedSummary(selectedIndex);
                        if (cached && cached.audio) {
                            playAudio(cached.audio);
                        }
                    }
                } else {
                    pauseAudio();
                }
                updateSpeakerIcon(currentAudio && !currentAudio.paused);
            });

            // Close speaker menu when clicking outside
            document.addEventListener('click', () => {
                speakerMenu.classList.add('hidden');
            });

            // Repeat: restart audio from beginning
            btnRepeat.addEventListener('click', () => {
                const selectedIndex = billSelect.value;
                const cached = getCachedSummary(selectedIndex);
                if (cached && cached.audio) {
                    if (isMuted) {
                        isMuted = false;
                        if (currentAudio) currentAudio.muted = false;
                    }
                    if (currentAudio) {
                        currentAudio.pause();
                        currentAudio.currentTime = 0;
                    }
                    isPaused = false;
                    playAudio(cached.audio);
                }
            });

            // Handle bill selection change
            billSelect.addEventListener('change', async () => {
                await loadBillComparison(false, true);
            });

            // Regenerate summary button
            btnRegenerate.addEventListener('click', async () => {
                const selectedIndex = billSelect.value;
                if (selectedIndex !== "") {
                    await loadBillComparison(true, true);
                }
            });

            // Load bills on page load
            loadBills();

            // Prevent accidental page close during generation
            window.addEventListener('beforeunload', (e) => {
                if (isGenerating) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });
        });
    </script>
</body>
</html>
